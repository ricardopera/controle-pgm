name: Infrastructure

on:
  push:
    branches: [main]
    paths:
      - 'infra/**'
      - '.github/workflows/infra.yml'
  pull_request:
    branches: [main]
    paths:
      - 'infra/**'

env:
  RESOURCE_GROUP: 'controle-pgm'
  LOCATION: 'brazilsouth'

jobs:
  validate:
    name: Validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Validate Bicep
        uses: azure/CLI@v2
        with:
          azcliversion: latest
          inlineScript: |
            export EXIT_CODE=0
            az bicep build --file infra/main.bicep > bicep-output.txt 2>&1 || export EXIT_CODE=$?
            
            python3 -c '
            import os
            try:
                with open("bicep-output.txt", "r") as f:
                    content = f.read()
                msg = content[-2000:].replace("%", "%25").replace("\r", "%0D").replace("\n", "%0A")
                if os.environ.get("EXIT_CODE") != "0":
                    print(f"::error title=Bicep Validation Failed::{msg}")
            except Exception as e:
                print(f"::error title=Debug Script Failed::{str(e)}")
            '
            exit $EXIT_CODE

      - name: What-if deployment
        uses: azure/CLI@v2
        with:
          azcliversion: latest
          inlineScript: |
            az deployment group what-if \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --template-file infra/main.bicep \
              --parameters infra/prod.bicepparam

  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: validate
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    steps:
      - uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy Bicep
        uses: azure/CLI@v2
        with:
          azcliversion: latest
          inlineScript: |
            az deployment group create \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --template-file infra/main.bicep \
              --parameters infra/prod.bicepparam

      - name: Get deployment outputs
        uses: azure/CLI@v2
        with:
          azcliversion: latest
          inlineScript: |
            az deployment group show \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --name main \
              --query properties.outputs
