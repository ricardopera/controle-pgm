name: Frontend CI/CD

on:
  push:
    branches: [main]
    paths:
      - 'frontend/**'
      - '.github/workflows/frontend.yml'
  pull_request:
    branches: [main]
    paths:
      - 'frontend/**'

env:
  NODE_VERSION: '20'

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: |
          cd frontend
          npm ci

      - name: Run ESLint
        run: |
          cd frontend
          npm run lint

      - name: Type check
        run: |
          cd frontend
          npm run typecheck

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: |
          cd frontend
          npm ci

      - name: Run tests
        run: |
          cd frontend
          set +e
          npm run test:ci 2>&1 | tee vitest-output.txt
          exit_code=${PIPESTATUS[0]}
          if [ "$exit_code" -ne 0 ]; then
            echo "\n--- Last 200 lines of Vitest output ---"
            tail -n 200 vitest-output.txt || true

            # Create a GitHub Actions annotation with a short, URL-escaped tail of the output.
            python3 -c '
            import sys
            try:
                with open("vitest-output.txt", "r") as f:
                    lines = f.readlines()
                tail = "".join(lines[-60:])
                msg = tail.replace("%", "%25").replace("\r", "%0D").replace("\n", "%0A")
                print(f"::error title=Vitest failed::{msg}")
            except Exception as e:
                print(f"::error title=Debug Script Failed::{str(e)}")
            '

            exit "$exit_code"
          fi

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: |
          cd frontend
          npm ci

      - name: Build
        run: |
          cd frontend
          npm run build
        env:
          VITE_API_URL: ${{ vars.VITE_API_URL }}

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist

  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy to Azure Static Website
        uses: azure/CLI@v2
        with:
          azcliversion: latest
          inlineScript: |
            STORAGE_ACCOUNT_NAME="${{ vars.STORAGE_ACCOUNT_NAME || 'controlepgmprod' }}"
            
            echo "Deploying to Storage Account: $STORAGE_ACCOUNT_NAME"

            export EXIT_CODE=0
            az storage blob upload-batch \
              --account-name "$STORAGE_ACCOUNT_NAME" \
              --destination '$web' \
              --source frontend/dist \
              --overwrite > az-output.txt 2>&1 || export EXIT_CODE=$?

            python3 -c '
            import os
            try:
                with open("az-output.txt", "r") as f:
                    content = f.read()
                msg = content[-2000:].replace("%", "%25").replace("\r", "%0D").replace("\n", "%0A")
                if os.environ.get("EXIT_CODE") != "0":
                    print(f"::error title=Azure CLI Failed::{msg}")
            except Exception as e:
                print(f"::error title=Debug Script Failed::{str(e)}")
            '

            exit $EXIT_CODE
